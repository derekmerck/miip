---
# Ansible playbook for standing up a single machine clinical and research archive
# TODO: Copy azure/xnat -> cirr1/xnat
# TODO: Add nginx reverse proxy for load balancing and https
# TODO: Create router_pacs role or clinical_pacs w routing subrole
# TODO: filter remote modalities by necessary, update with local vs. external addresses
# TODO: Create anonymizer

- name: Create Clinical and Research Archives

  hosts:
    - vagrant

  vars:
    # Wipes DB, useful if rebuilding from scratch after a failed build
    # ALLOW_CLEAN: True

    # Send a notification to a Slack channel
    # NOTIFY: True

#  vars_files:
#    - secrets.yml  # Credentials

  roles:
    - { role: orthanc, tags: "orthanc", name: "orthanc_archive" }
    - { role: xnat,    tags: "xnat" }
    - { role: splunk,  tags: "splunk"}

  post_tasks:
    - name: Notify Slack that the servers have been updated
      local_action: >
        slack
        token={{ credentials.slack.token }}
        msg="MIIP server `{{ inventory_hostname }}` configured"
      when: NOTIFY is defined and NOTIFY and credentials.slack.token is defined