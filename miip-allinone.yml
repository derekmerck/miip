---
# Ansible playbook for standing up a single machine MIIP supporting all roles

# TODO: Add wait_for for postgres up

- name: All-in-one MIIP

  hosts:
    - cirr2

  vars:
    # Wipes DB, useful if rebuilding from scratch after a failed build
    # clean_xnat: True
    # notify: True

    ports:
      postgres:
        sql:    1433
      orthanc:
        dicom:  4242
        html:   4280
      xnat:
        dicom:  5242
        html:   5280
      splunk:
        syslog: 1514
        html:   1580
        api:    1583

  vars_files:
    - secrets.yml

  pre_tasks:

    - name: install rhel-extra for cent/rhel
      sudo: True
      command: rpm -iUvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'
      ignore_errors: yes  # Maybe already installed

    - name: install packages
      package: name={{ item }}
      sudo: True
      with_items:
        - git
        - python-pip
        - python-psycopg2
        - python-setuptools

    - name: install pip packages
      pip: name={{ item }}
      sudo: True
      with_items:
        - docker-py

  roles:
    - clinical_pacs
#    - research_pacs
#    - remote_logging

  post_tasks:
    - name: Notify Slack that the servers have been updated
      local_action: >
        slack
        token={{ credentials.slack.token }}
        msg="MIIP server `{{ inventory_hostname }}` configured"
      when: notify is defined and notify