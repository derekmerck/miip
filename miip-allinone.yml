---

# Ansible playbook for standing up a single machine MIIP supporting all roles
# TODO: **Critical** -- move cirr1 data volumes onto larger /research/ storage partition
# TODO: Copy cirr0/orthanc -> cirr1/orthanc
# TODO: Copy azure/xnat -> cirr1/xnat
# TODO: Add nginx reverse proxy for load balancing and https

- name: All-in-one MIIP

  hosts:
    - cirr1

  vars:
    # Wipes DB, useful if rebuilding from scratch after a failed build
    # clean_xnat: True

    # Send a notification to a Slack channel
    # notify: True

  vars_files:
    - config.yml   # Ports and service settings
    - secrets.yml  # Credentials

  pre_tasks:

    - name: install rhel-extra for cent/rhel
      sudo: True
      command: rpm -iUvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
      when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'
      ignore_errors: yes  # Maybe already installed

    - name: install packages
      package: name={{ item }}
      sudo: True
      with_items:
        - git
        - python-pip
        - python-psycopg2
        - python-setuptools

    - name: install pip packages
      pip: name={{ item }}
      sudo: True
      with_items:
        - docker-py

  roles:
    - clinical_pacs
    - research_pacs
    - remote_logging

  post_tasks:
    - name: Notify Slack that the servers have been updated
      local_action: >
        slack
        token={{ credentials.slack.token }}
        msg="MIIP server `{{ inventory_hostname }}` configured"
      when: notify is defined and notify